@using RazorPad.Web.Website.Extensions
@model RazorPad.Web.Fiddle

@section Head {
    <link href="@Url.Content("~/Content/shCore.css")" type="text/css" rel="stylesheet" />
    <link href="@Url.Content("~/Content/shThemeDefault.css")" type="text/css" rel="stylesheet" />
    <link href="@Url.Content("~/Content/themes/default/codemirror.css")" rel="stylesheet" type="text/css" />
}

@section Actions {
    <ul class="actionItems">
        <li><button id="execute">Execute</button></li>
        <li><button id="save">Save</button></li>
        <li style="display:none;"><button id="clone">Clone</button></li>
    </ul>

    <ul class="actionItems floatRight">
        @if (!User.Identity.IsAuthenticated)
        {
            <li><button onclick="location.href = '@Url.Login()';">Login</button></li>
        }
        else
        {
            <li>Welcome, <strong>@User.Identity.Name</strong>
                <button onclick="location.href = '@Url.Logout()';">Logout</button>
            </li>
        }
    </ul>
}

@if (Model != null && !string.IsNullOrEmpty(Model.Id))
{
    <input type="hidden" id="fiddleId" value="@Model.Id" />
}
           
<div id="panes">
    
    <div id="razorPane" class="inlinebox">
        @Html.Partial("_RazorPane", Model.View ?? "")
    </div>
    <div id="modelPane" class="inlinebox">
        @Html.Partial("_ModelPane")
    </div>
    <div id="resultsPane" class="">
        @Html.Partial("_ResultsPane")
    </div>

    <div id="loading"></div>

</div>


@section Tail {

<script type="text/javascript" charset="utf-8">
    var RazorPad = typeof (RazorPad) == 'undefined' ? {} : RazorPad;
    RazorPad.siteRoot = "@(Url.Content("~/"))";
    RazorPad.razorEditor = null;
    RazorPad.isUserAuthenticated = @(User.Identity.IsAuthenticated ? "true" : "false"); 
    $(function () {

        function resizeRazorEditor() {
            $(RazorPad.razorEditor.getScrollerElement()).css({
                height: $("#razorPane").height() - $("#viewHeader").height(),
                width: $("#razorPane").width()
            });
            RazorPad.razorEditor.refresh();
            resizeModelProps();
        }

        function resizeModelProps() {
            var $modelPane = $('#modelPane');
            $modelPane.find('.modelProps')
                         .height(
                            $modelPane.height()
                            - $modelPane.find('.paneheader').outerHeight(true)
                            - $modelPane.find('.propinput').outerHeight(true)
                            - 10//modelProps top and bottom padding
                            );
        }

        var outerLayout = $('body').layout({

            north__paneSelector: "#toolbar",
            north__resizable: false,
            north__spacing_open: 0,
            center__paneSelector: "#panes",
            resizeWhileDragging: true,
            closable: false
        });

        var innerLayout = $('#panes').layout({
            closable: false,
            center__paneSelector: "#modelPane",
            west__paneSelector: "#razorPane",
            west__size: Math.floor((screen.width / 1.67) - 10),
            west__maxSize: "70%",
            west__minSize: 400,
            south__paneSelector: "#resultsPane",
            south__maxSize: "70%",
            south__size: Math.floor((screen.height / 2) - 100),
            south__minSize: 200,
            resizeWhileDragging: true,
            onresize: resizeRazorEditor
        });


        RazorPad.razorEditor = CodeMirror.fromTextArea(document.getElementById("razorEditor"), {
            mode: "text/html",
            lineNumbers: true,
            tabMode: "indent",
            matchBrackets: true,
            tabIndex: -1,
            lineWrapping: true,
            extraKeys: {
                "Ctrl-S": function(){ RazorPad.saveTemplate(); },
                "Ctrl-E": function(){ RazorPad.executeTemplate(); }
            }
        });

        $("#panes").css('visibility', 'visible');

        $(window).resize(resizeRazorEditor).resize();

        if($("#fiddleId").val()){
            //Execute the template (adding timeout to load the layout before ajax calls)
            setTimeout(function(){
                RazorPad.executeTemplate();
            }, 200);
        }
    });
</script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/jquery-ui.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/underscore.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/splitter.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/jquery.watermark.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/stringformat.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/XRegExp.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/shCore.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/shBrushCSharp.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/shBrushXml.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/codemirror/codemirror.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/codemirror/mode/xml.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/codemirror/mode/javascript.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/codemirror/mode/css.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/codemirror/mode/htmlmixed.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/hpTabs.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/jquery.hotkeys.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/RazorPad.js")"> </script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Scripts/jquery.layout-latest.js")"> </script>
}